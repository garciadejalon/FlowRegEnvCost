{
    "collab_server" : "",
    "contents" : "#' f_structure_date1 - Transforms and reorders the flow data\n#' @param  S_Day Position in Date string of the first digit of two-digits day\n#' @param  S_Month Position in Date string of the first digits of two-digits month\n#' @param  S_Year Position in Date string of the first digits of four-digits year\n#' @return The transformed dataframe on a daily basis is ready for calculations\n#' @export\nf_structure_date1 <-function(S_Day,S_Month,S_Year){\n  Ye <- substr(data0$Date, start = S_Year, stop = (S_Year+3))\n  Mo <- substr(data0$Date, start = S_Month, stop = (S_Month+1))\n  Da <- substr(data0$Date, start = S_Day, stop = (S_Day+1))\n  Date_adjusted <- paste(Ye,\"-\",Mo,\"-\",Da, sep=\"\")\n  data0$Date <-Date_adjusted\n  Date_real <- seq(as.Date(data0$Date[1]), as.Date(data0$Date[length(data0$Date)]), by=\"days\")\n  dataframe_adj <- data.frame(Date=Date_real, Flow=NA)\n  dataframe_adj$Flow[which(as.character(Date_real) %in% data0$Date)] <- data0$Flow[which(data0$Date %in% as.character(Date_real))]\n  data0 <- dataframe_adj\n  return(data0)\n}\n\n\n#' f_years2 - Sorts the flow data per years - Each year is a column\n#' @param  First_day First day of the year to consider in the analysis starting on October 1st written as character (e.g. \"1964-10-01\")\n#' @param  Last_day First day of the year to consider in the analysis finishing on September 30th written as character (e.g. \"2011-09-30\")\n#' @return The transformed dataframe per year is ready for calculations\n#' @export\nf_years2 <- function(First_day,Last_day){\n  Date_col <- seq(as.Date(\"2011-10-01\"), as.Date(\"2012-09-30\"), by=\"days\")\n  Date <- seq(as.Date(First_day), as.Date(Last_day), by=\"days\")\n  Flow_adj <- subset(data0, (Date>=First_day)&(Date<=Last_day), select=\"Flow\")\n  data1 <- data.frame(Date=Date, Flow = Flow_adj)\n  ##Analysis of flows\n  Years0 <- seq(as.numeric(substr(First_day, start = 1, stop = 4))+1, as.numeric(substr(Last_day, start = 1, stop = 4)))\n  Years1 <- paste(\"Y\",Years0,sep=\"\")\n  my_mx <- matrix(ncol=length(Years1), nrow=length(Date_col))\n  colnames(my_mx) <- Years1\n  for(i in 1:length(Years1)){\n    if(length(subset(data1, (Date>paste(Years0[i]-1,\"-09-30\",sep=\"\")) & (Date<= paste(Years0[i],\"-09-30\",sep=\"\")),select=\"Flow\")[,1])==365){\n      my_mx[1:151,i] <- subset(data1, (Date>paste(Years0[i]-1,\"-09-30\",sep=\"\")) & (Date<= paste(Years0[i],\"-09-30\",sep=\"\")),select=\"Flow\")[1:151,1]\n      my_mx[152,i] <- NA\n      my_mx[153:366,i] <- subset(data1, (Date>paste(Years0[i]-1,\"-09-30\",sep=\"\")) & (Date<= paste(Years0[i],\"-09-30\",sep=\"\")),select=\"Flow\")[152:365,1]\n    }else{\n      my_mx[,i] <-subset(data1, (Date>paste(Years0[i]-1,\"-09-30\",sep=\"\")) & (Date<= paste(Years0[i],\"-09-30\",sep=\"\")),select=\"Flow\")[,1]\n    }\n  }\n  my_mx1 <- replace(my_mx, my_mx<0, NA)\n  my_df <- data.frame(Date=substr(Date_col, start = 6, stop = 11), my_mx1)\n  return(my_df)\n}\n\n\n#' f_summary_flow3 - Provides a summary of flow data during the pre-impact period\n#' @param  First_day First day of the year to consider in the analysis starting on October 1st written as character (e.g. \"1964-10-01\")\n#' @param  Last_day First day of the year to consider in the analysis finishing on September 30th written as character (e.g. \"2011-09-30\")\n#' @param  Year_impact Year when the human impact started (e.g. the construction of a dam)\n#' @return Provides a dataframe on a daily basis of mean, min, p10, p25, median, p75, p90 and max values during the pre-impact period.\n#' @export\nf_summary_flow3 <- function(First_day, Last_day, Year_impact){\n  Years0 <- seq(as.numeric(substr(First_day, start = 1, stop = 4))+1, as.numeric(substr(Last_day, start = 1, stop = 4)))\n  Date_col <- seq(as.Date(\"2011-10-01\"), as.Date(\"2012-09-30\"), by=\"days\")\n  my_mx1_0 <- f_years2(First_day=First_day,Last_day=Last_day)\n  my_mx1 <- my_mx1_0[,2:ncol(my_mx1_0)]\n  ##summary of daily data of flows\n  means<- rowMeans(my_mx1, na.rm = TRUE)\n  medians <- apply (my_mx1, 1, median, na.rm = TRUE)\n  percentiles <- apply(my_mx1, 1, quantile, na.rm = TRUE)\n  m <- rbind(means, percentiles)\n  daily_summary <- t(m)\n  ##summary of daily data of flows BEFORE impact (1965-1987)\n  ref_years_data <- my_mx1[,1:(match(Year_impact, Years0)-1)] ##only years BEFORE the impact\n  means<- rowMeans(ref_years_data, na.rm = TRUE)\n  medians <- apply (ref_years_data, 1, median, na.rm = TRUE)\n  percentiles <- apply(ref_years_data, 1, quantile, probs=c(0,0.1,0.25,0.5,0.75,0.9,1), na.rm = TRUE, name=F)\n  m <- rbind(means, percentiles)\n  daily_summary_ref_years <- t(m)\n  cnames <- c(\"mean\", \"min\", \"p10\", \"p25\", \"median\", \"p75\", \"p90\", \"max\")\n  colnames(daily_summary_ref_years) <- cnames\n  daily_summary_ref_years_final <- data.frame(Day =substr(Date_col, start = 6, stop = 11),daily_summary_ref_years)\n  return(daily_summary_ref_years_final)\n}\n\n\n\n#' f_adm_range4 - Calculates the admissible range of flow variability\n#' @param  First_day First day of the year to consider in the analysis starting on October 1st written as character (e.g. \"1964-10-01\")\n#' @param  Last_day First day of the year to consider in the analysis finishing on September 30th written as character (e.g. \"2011-09-30\")\n#' @param  Year_impact Year when the human impact started (e.g. the construction of a dam)\n#' @return Calculates the admissible range of flow variability based on the flow data during the pre-impact period.\n#' @export\nf_adm_range4 <- function(First_day, Last_day, Year_impact){\n  Years0 <- seq(as.numeric(substr(First_day, start = 1, stop = 4))+1, as.numeric(substr(Last_day, start = 1, stop = 4)))\n  my_mx1_0 <- f_years2(First_day=First_day,Last_day=Last_day)\n  my_mx1 <- my_mx1_0[,2:ncol(my_mx1_0)]\n  daily_summary_ref_years_0 <- f_summary_flow3(First_day=First_day,Last_day=Last_day,Year_impact=Year_impact)\n  daily_summary_ref_years <- daily_summary_ref_years_0[,2:ncol(daily_summary_ref_years_0)]\n  Date <- seq(as.Date(\"1999-10-01\"), as.Date(\"2000-09-30\"), by=\"days\")\n  daily_summary_ref <- cbind(Date, daily_summary_ref_years)\n  all_years <- cbind(Date, my_mx1)\n  ## Layouts\n  t_secs_1_day <- 1 # 8=86400(sec/dia)\n  t_days_1_year <- 366 # 3=366(dias)\n  layouts <- t_days_1_year * t_secs_1_day\n  #t_one_day_ar   <- array(1:layouts, dim=c(86400,1,366))  # time points of 1day at which the model calculates\n  t_one_day <- array(1:layouts, c(t_secs_1_day,1,t_days_1_year)) #8=86400(sec/dia), 1=1(filas), 3=366(dias)\n  ## caudal de referencia LOW\n  q_ref_cubic_feet_low  <- subset(daily_summary_ref, select=p10)\n  q_ref_sin_interp_low <- q_ref_cubic_feet_low[1:t_days_1_year,] # caudal de referencia (m3/s) para 1st of October (1913-1952)\n  q_ref_sin_interp22_low <- array(0, c(t_secs_1_day,1,t_days_1_year))\n  q_ref_sin_interp22_low[, , t_days_1_year] <- seq(\n    q_ref_sin_interp_low[t_days_1_year], q_ref_sin_interp_low[1],\n    length.out=t_secs_1_day)\n  t_days_1_year2 <- t_days_1_year- 1\n  f_b <- function(m){\n    seq(q_ref_sin_interp_low[m], q_ref_sin_interp_low[m+1], length.out=t_secs_1_day)\n  }\n  for(i in 1:t_days_1_year2){\n    q_ref_sin_interp22_low[, , i] <- f_b(i)\n  }\n  q_ref_low <- c(q_ref_sin_interp22_low)\n  #Smoothing Low flow of reference\n  require(zoo)\n  Flow_p10_30days <- c(q_ref_low[352:366], q_ref_low,q_ref_low[1:14])\n  Flow_p10_30day <- rollmean(Flow_p10_30days, 30)\n  ## caudal de referencia HIGH\n  q_ref_cubic_feet_high  <- subset(daily_summary_ref, select=p90)\n  q_ref_sin_interp_high <- q_ref_cubic_feet_high[1:t_days_1_year,] # caudal de referencia (m3/s) para 1st of October (1913-1952)\n  q_ref_sin_interp22_high <- array(0, c(t_secs_1_day,1,t_days_1_year))\n  q_ref_sin_interp22_high[, , t_days_1_year] <- seq(\n    q_ref_sin_interp_high[t_days_1_year], q_ref_sin_interp_high[1],\n    length.out=t_secs_1_day)\n  t_days_1_year2 <- t_days_1_year- 1\n  f_b <- function(m){\n    seq(q_ref_sin_interp_high[m], q_ref_sin_interp_high[m+1], length.out=t_secs_1_day)\n  }\n  for(i in 1:t_days_1_year2){\n    q_ref_sin_interp22_high[, , i] <- f_b(i)\n  }\n  q_ref_high <- c(q_ref_sin_interp22_high)\n  #Smoothing High flow of reference\n  Flow_p90_30days <- c(q_ref_high[352:366], q_ref_high,q_ref_high[1:14])\n  Flow_p90_30day <- rollmean(Flow_p90_30days, 30)\n\n  tab_adm_range <- data.frame(Date=substr(Date, start = 6, stop = 11), Low_ref_flow = q_ref_low, High_ref_flow = q_ref_high,\n                              Smoothed_ref_Low =Flow_p10_30day, Smoothed_ref_High = Flow_p90_30day)\n  return(tab_adm_range)\n}\n\n\n#' f_plot_adm_range4 - Plots the admissible range of flow variability\n#' @param  River_name Name of the river as character (e.g. \"Ebro\")\n#' @param  First_day First day of the year to consider in the analysis starting on October 1st written as character (e.g. \"1964-10-01\")\n#' @param  Last_day First day of the year to consider in the analysis finishing on September 30th written as character (e.g. \"2011-09-30\")\n#' @param  Year_impact Year when the human impact started (e.g. the construction of a dam)\n#' @return Plots the admissible range of flow variability based on the flow data during the pre-impact period.\n#' @export\nf_plot_adm_range4 <- function(River_name, First_day, Last_day, Year_impact){\n\n  Years0 <- seq(as.numeric(substr(First_day, start = 1, stop = 4))+1, as.numeric(substr(Last_day, start = 1, stop = 4)))\n  my_mx1_0 <- f_years2(First_day=First_day,Last_day=Last_day)\n  my_mx1 <- my_mx1_0[,2:ncol(my_mx1_0)]\n  daily_summary_ref_years_0 <- f_summary_flow3(First_day=First_day,Last_day=Last_day,Year_impact=Year_impact)\n  daily_summary_ref_years <- daily_summary_ref_years_0[,2:ncol(daily_summary_ref_years_0)]\n  Date <- seq(as.Date(\"1999-10-01\"), as.Date(\"2000-09-30\"), by=\"days\")\n  daily_summary_ref <- cbind(Date, daily_summary_ref_years)\n  all_years <- cbind(Date, my_mx1)\n  ## Layouts\n  t_secs_1_day <- 1 # 8=86400(sec/dia)\n  t_days_1_year <- 366 # 3=366(dias)\n  layouts <- t_days_1_year * t_secs_1_day\n  #t_one_day_ar   <- array(1:layouts, dim=c(86400,1,366))  # time points of 1day at which the model calculates\n  t_one_day <- array(1:layouts, c(t_secs_1_day,1,t_days_1_year)) #8=86400(sec/dia), 1=1(filas), 3=366(dias)\n  ## caudal de referencia LOW\n  q_ref_cubic_feet_low  <- subset(daily_summary_ref, select=p10)\n  q_ref_sin_interp_low <- q_ref_cubic_feet_low[1:t_days_1_year,] # caudal de referencia (m3/s) para 1st of October (1913-1952)\n  q_ref_sin_interp22_low <- array(0, c(t_secs_1_day,1,t_days_1_year))\n  q_ref_sin_interp22_low[, , t_days_1_year] <- seq(\n    q_ref_sin_interp_low[t_days_1_year], q_ref_sin_interp_low[1],\n    length.out=t_secs_1_day)\n  t_days_1_year2 <- t_days_1_year- 1\n  f_b <- function(m){\n    seq(q_ref_sin_interp_low[m], q_ref_sin_interp_low[m+1], length.out=t_secs_1_day)\n  }\n  for(i in 1:t_days_1_year2){\n    q_ref_sin_interp22_low[, , i] <- f_b(i)\n  }\n  q_ref_low <- c(q_ref_sin_interp22_low)\n  #Smoothing Low flow of reference\n  require(zoo)\n  Flow_p10_30days <- c(q_ref_low[352:366], q_ref_low,q_ref_low[1:14])\n  Flow_p10_30day <- rollmean(Flow_p10_30days, 30)\n  ## caudal de referencia HIGH\n  q_ref_cubic_feet_high  <- subset(daily_summary_ref, select=p90)\n  q_ref_sin_interp_high <- q_ref_cubic_feet_high[1:t_days_1_year,] # caudal de referencia (m3/s) para 1st of October (1913-1952)\n  q_ref_sin_interp22_high <- array(0, c(t_secs_1_day,1,t_days_1_year))\n  q_ref_sin_interp22_high[, , t_days_1_year] <- seq(\n    q_ref_sin_interp_high[t_days_1_year], q_ref_sin_interp_high[1],\n    length.out=t_secs_1_day)\n  t_days_1_year2 <- t_days_1_year- 1\n  f_b <- function(m){\n    seq(q_ref_sin_interp_high[m], q_ref_sin_interp_high[m+1], length.out=t_secs_1_day)\n  }\n  for(i in 1:t_days_1_year2){\n    q_ref_sin_interp22_high[, , i] <- f_b(i)\n  }\n  q_ref_high <- c(q_ref_sin_interp22_high)\n  #Smoothing High flow of reference\n  Flow_p90_30days <- c(q_ref_high[352:366], q_ref_high,q_ref_high[1:14])\n  Flow_p90_30day <- rollmean(Flow_p90_30days, 30)\n  plot(q_ref_high, type=\"l\",xaxt='n', ylab=\"\", xlab=\"\", ylim=c(0,max(q_ref_high)*1.5),\n       xlim=c(0,390), main=paste(\"Admissible range in\",River_name, \"River\"))\n  mtext(side=2,line=2.5,expression('Flow (m '^3*'/s)'))\n  legend(\"topleft\", col=c(1,2,152), cex=1, lty=c(1,1,1), lwd=c(1,1,10),bty=\"n\",\n         legend = c(paste(\"Reference flow from non-regulated period (\", Years0[1],\"-\",Year_impact-1,\")\" ,sep=\"\"),\n                    expression('Smoothed reference flow (Q'[10]*' & Q'[90]*')', 'Admissible range of regulated flow variability' )))\n  x <- c(1:366,366:1)\n  poly_Flow_p90_p10_30day <- c(Flow_p90_30day,rev(Flow_p10_30day))\n  polygon(x, poly_Flow_p90_p10_30day, col = \"gray\", border = \"gray\")\n  lines(q_ref_high, col=1)\n  lines(q_ref_low, col=1)\n  lines(Flow_p90_30day, col=2)\n  lines(Flow_p10_30day, col=2)\n  axis(1, lwd=1, at=0+15, labels=\"OC\")\n  axis(1, lwd=1, at=31+15, labels=\"NO\")\n  axis(1, lwd=1, at=61+15, labels=\"DE\")\n  axis(1, lwd=1, at=92+15, labels=\"JA\")\n  axis(1, lwd=1, at=123+15, labels=\"FE\")\n  axis(1, lwd=1, at=152+15, labels=\"MR\")\n  axis(1, lwd=1, at=183+15, labels=\"AP\")\n  axis(1, lwd=1, at=213+15, labels=\"MY\")\n  axis(1, lwd=1, at=244+15, labels=\"JN\")\n  axis(1, lwd=1, at=274+15, labels=\"JL\")\n  axis(1, lwd=1, at=305+15, labels=\"AU\")\n  axis(1, lwd=1, at=336+15, labels=\"SE\")\n  axis(2, lwd=1, at=0, labels=\"0\")\n}\n\n\n#' f_impact5 - Calculates the daily environmental impact of flow regulation (high- and low-flow impact)\n#' @param  First_day First day of the year to consider in the analysis starting on October 1st written as character (e.g. \"1964-10-01\")\n#' @param  Last_day First day of the year to consider in the analysis finishing on September 30th written as character (e.g. \"2011-09-30\")\n#' @param  Year_evaluated Year when the environmental impact is evaluated\n#' @param  Year_impact Year when the human impact started (e.g. the construction of a dam)\n#' @return Calculates the daily environmental impact of flow regulation (high- and low-flow impact).\n#' @export\nf_impact5 <- function(First_day, Last_day,Year_evaluated,Year_impact){\n  my_mx1_0 <- f_years2(First_day=First_day,Last_day=Last_day)\n  my_mx1 <- my_mx1_0[,2:ncol(my_mx1_0)]\n  Date <- seq(as.Date(\"1999-10-01\"), as.Date(\"2000-09-30\"), by=\"days\")\n  all_years <- cbind(Date, my_mx1)\n  ## Layouts\n  t_secs_1_day <- 1 # 8=86400(sec/dia)\n  t_days_1_year <- 366 # 3=366(dias)\n  layouts <- t_days_1_year * t_secs_1_day\n  #Flow (m3/s) AFTER impact (eg. 2010)\n  q_year_evaluated <- c(all_years[,paste(\"Y\",Year_evaluated, sep=\"\")])\n  require(zoo)\n  ## 3 days\n  q_year_evaluated_3days <- c(q_year_evaluated[366], q_year_evaluated,q_year_evaluated[1])\n  q_year_evaluated_3day <- rollapply(q_year_evaluated_3days, 3,median,na.rm=TRUE)\n  ## 7 days\n  q_year_evaluated_7days <- c(q_year_evaluated[364:366], q_year_evaluated,q_year_evaluated[1:3])\n  q_year_evaluated_7day <- rollapply(q_year_evaluated_7days, 7,median,na.rm=TRUE)\n  ## 30 days\n  q_year_evaluated_30days <- c(q_year_evaluated[352:366], q_year_evaluated,q_year_evaluated[1:14])\n  q_year_evaluated_30day <- rollapply(q_year_evaluated_30days, 30,median,na.rm=TRUE)\n  adm_range <- f_adm_range4 (First_day=First_day, Last_day=Last_day,Year_impact=Year_impact)\n  Flow_p10_30day <- adm_range$Smoothed_ref_Low\n  Flow_p90_30day <- adm_range$Smoothed_ref_High\n  ###### Environmental Impact\n  #Impact low flows\n  ## 1 day low flow\n  Imp_year_evaluated_low_1d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_low_1d)){\n    if(is.na(q_year_evaluated[i])){\n      Imp_year_evaluated_low_1d[i] <- NA\n    } else {\n      if (q_year_evaluated[i]< Flow_p10_30day[i]){\n        Imp_year_evaluated_low_1d[i] <- (Flow_p10_30day[i]- q_year_evaluated[i])/(Flow_p10_30day[i])\n      } else{\n        Imp_year_evaluated_low_1d[i] <- 0\n      }\n    }\n  }\n  ## 3 days low flow\n  Imp_year_evaluated_low_3d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_low_3d)){\n    if(is.na(q_year_evaluated_3day[i])){\n      Imp_year_evaluated_low_3d[i] <- NA\n    } else {\n      if (q_year_evaluated_3day[i]< Flow_p10_30day[i]){\n        Imp_year_evaluated_low_3d[i] <- (Flow_p10_30day[i]- q_year_evaluated_3day[i])/(Flow_p10_30day[i])\n      } else{\n        Imp_year_evaluated_low_3d[i] <- 0\n      }\n    }\n  }\n  ## 7 days low flow\n  Imp_year_evaluated_low_7d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_low_7d)){\n    if(is.na(q_year_evaluated_7day[i])){\n      Imp_year_evaluated_low_7d[i] <- NA\n    } else {\n      if (q_year_evaluated_7day[i]< Flow_p10_30day[i]){\n        Imp_year_evaluated_low_7d[i] <- (Flow_p10_30day[i]- q_year_evaluated_7day[i])/(Flow_p10_30day[i])\n      } else{\n        Imp_year_evaluated_low_7d[i] <- 0\n      }\n    }\n  }\n  ## 30 days low flow\n  Imp_year_evaluated_low_30d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_low_30d)){\n    if(is.na(q_year_evaluated_30day[i])){\n      Imp_year_evaluated_low_30d[i] <- NA\n    } else {\n      if (q_year_evaluated_30day[i]< Flow_p10_30day[i]){\n        Imp_year_evaluated_low_30d[i] <- (Flow_p10_30day[i]- q_year_evaluated_30day[i])/(Flow_p10_30day[i])\n      } else{\n        Imp_year_evaluated_low_30d[i] <- 0\n      }\n    }\n  }\n  Imp_year_evaluated_low <- cbind(Imp_year_evaluated_low_1d,Imp_year_evaluated_low_3d,\n                                  Imp_year_evaluated_low_7d,Imp_year_evaluated_low_30d)\n  ## 1 day high flow\n  Imp_year_evaluated_high_1d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_high_1d)){\n    if(is.na(q_year_evaluated[i])){\n      Imp_year_evaluated_high_1d[i] <- NA\n    } else {\n      if (q_year_evaluated[i]> Flow_p90_30day[i]){\n        Imp_year_evaluated_high_1d[i] <- (-Flow_p90_30day[i]+ q_year_evaluated[i])/(q_year_evaluated[i])\n      } else{\n        Imp_year_evaluated_high_1d[i] <- 0\n      }\n    }\n  }\n  ## 3 days high flow\n  Imp_year_evaluated_high_3d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_high_3d)){\n    if(is.na(q_year_evaluated_3day[i])){\n      Imp_year_evaluated_high_3d[i] <- NA\n    } else {\n      if (q_year_evaluated_3day[i]> Flow_p90_30day[i]){\n        Imp_year_evaluated_high_3d[i] <- (-Flow_p90_30day[i]+ q_year_evaluated_3day[i])/(q_year_evaluated_3day[i])\n      } else{\n        Imp_year_evaluated_high_3d[i] <- 0\n      }\n    }\n  }\n  ## 7 days high flow\n  Imp_year_evaluated_high_7d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_high_7d)){\n    if(is.na(q_year_evaluated_7day[i])){\n      Imp_year_evaluated_high_7d[i] <- NA\n    } else {\n      if (q_year_evaluated_7day[i]> Flow_p90_30day[i]){\n        Imp_year_evaluated_high_7d[i] <- (-Flow_p90_30day[i]+ q_year_evaluated_7day[i])/(q_year_evaluated_7day[i])\n      } else{\n        Imp_year_evaluated_high_7d[i] <- 0\n      }\n    }\n  }\n  ## 30 days high flow\n  Imp_year_evaluated_high_30d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_high_30d)){\n    if(is.na(q_year_evaluated_30day[i])){\n      Imp_year_evaluated_high_30d[i] <- NA\n    } else {\n      if (q_year_evaluated_30day[i]> Flow_p90_30day[i]){\n        Imp_year_evaluated_high_30d[i] <- (-Flow_p90_30day[i]+ q_year_evaluated_30day[i])/(q_year_evaluated_30day[i])\n      } else{\n        Imp_year_evaluated_high_30d[i] <- 0\n      }\n    }\n  }\n  Imp_year_evaluated_high <- cbind(Imp_year_evaluated_high_1d,Imp_year_evaluated_high_3d,\n                                   Imp_year_evaluated_high_7d,Imp_year_evaluated_high_30d)\n  impact_total <- Imp_year_evaluated_low + Imp_year_evaluated_high\n  Impact_High <- rowMeans(Imp_year_evaluated_high)\n  Impact_Low <- rowMeans(Imp_year_evaluated_low)\n  Impact_Total <- rowMeans(impact_total)\n  Impacts <- data.frame(Date=substr(Date, start = 6, stop = 11), Impact_Low=Impact_Low, Impact_High=Impact_High, Impact_Total=Impact_Total)\n  return(Impacts)\n}\n\n\n\n#' f_plot_impact5 - Plots the daily environmental impact of flow regulation (high- and low-flow impact)\n#' @param  River_name Name of the river written as character (e.g. \"Ebro\")\n#' @param  First_day First day of the year to consider in the analysis starting on October 1st written as character (e.g. \"1964-10-01\")\n#' @param  Last_day First day of the year to consider in the analysis finishing on September 30th written as character (e.g. \"2011-09-30\")\n#' @param  Year_evaluated Year when the environmental impact is evaluated\n#' @param  Year_impact Year when the human impact started (e.g. the construction of a dam)\n#' @return Plots the daily environmental impact of flow regulation (high- and low-flow impact).\n#' @export\nf_plot_impact5 <- function(River_name,First_day, Last_day,Year_evaluated, Year_impact){\n  my_mx1_0 <- f_years2(First_day=First_day,Last_day=Last_day)\n  my_mx1 <- my_mx1_0[,2:ncol(my_mx1_0)]\n  Date <- seq(as.Date(\"1999-10-01\"), as.Date(\"2000-09-30\"), by=\"days\")\n  all_years <- cbind(Date, my_mx1)\n  adm_range <- f_adm_range4 (First_day=First_day, Last_day=Last_day,Year_impact=Year_impact)\n  Flow_p10_30day <- adm_range$Smoothed_ref_Low\n  Flow_p90_30day <- adm_range$Smoothed_ref_High\n  q_ref_high <- adm_range$High_ref_flow\n  q_ref_low <- adm_range$Low_ref_flow\n  ## Layouts\n  t_secs_1_day <- 1 # 8=86400(sec/dia)\n  t_days_1_year <- 366 # 3=366(dias)\n  layouts <- t_days_1_year * t_secs_1_day\n  #Flow (m3/s) AFTER impact (eg. 2010)\n  q_year_evaluated <- c(all_years[,paste(\"Y\",Year_evaluated, sep=\"\")])\n  ## 3 days\n  q_year_evaluated_3days <- c(q_year_evaluated[366], q_year_evaluated,q_year_evaluated[1])\n  q_year_evaluated_3day <- rollapply(q_year_evaluated_3days, 3,median,na.rm=TRUE)\n  ## 7 days\n  q_year_evaluated_7days <- c(q_year_evaluated[364:366], q_year_evaluated,q_year_evaluated[1:3])\n  q_year_evaluated_7day <- rollapply(q_year_evaluated_7days, 7,median,na.rm=TRUE)\n  ## 30 days\n  q_year_evaluated_30days <- c(q_year_evaluated[352:366], q_year_evaluated,q_year_evaluated[1:14])\n  q_year_evaluated_30day <- rollapply(q_year_evaluated_30days, 30,median,na.rm=TRUE)\n  ###### Environmental Impact\n  #Impact low flows\n  ## 1 day low flow\n  Imp_year_evaluated_low_1d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_low_1d)){\n    if(is.na(q_year_evaluated[i])){\n      Imp_year_evaluated_low_1d[i] <- NA\n    } else {\n      if (q_year_evaluated[i]< Flow_p10_30day[i]){\n        Imp_year_evaluated_low_1d[i] <- (Flow_p10_30day[i]- q_year_evaluated[i])/(Flow_p10_30day[i])\n      } else{\n        Imp_year_evaluated_low_1d[i] <- 0\n      }\n    }\n  }\n  ## 3 days low flow\n  Imp_year_evaluated_low_3d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_low_3d)){\n    if(is.na(q_year_evaluated_3day[i])){\n      Imp_year_evaluated_low_3d[i] <- NA\n    } else {\n      if (q_year_evaluated_3day[i]< Flow_p10_30day[i]){\n        Imp_year_evaluated_low_3d[i] <- (Flow_p10_30day[i]- q_year_evaluated_3day[i])/(Flow_p10_30day[i])\n      } else{\n        Imp_year_evaluated_low_3d[i] <- 0\n      }\n    }\n  }\n  ## 7 days low flow\n  Imp_year_evaluated_low_7d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_low_7d)){\n    if(is.na(q_year_evaluated_7day[i])){\n      Imp_year_evaluated_low_7d[i] <- NA\n    } else {\n      if (q_year_evaluated_7day[i]< Flow_p10_30day[i]){\n        Imp_year_evaluated_low_7d[i] <- (Flow_p10_30day[i]- q_year_evaluated_7day[i])/(Flow_p10_30day[i])\n      } else{\n        Imp_year_evaluated_low_7d[i] <- 0\n      }\n    }\n  }\n  ## 30 days low flow\n  Imp_year_evaluated_low_30d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_low_30d)){\n    if(is.na(q_year_evaluated_30day[i])){\n      Imp_year_evaluated_low_30d[i] <- NA\n    } else {\n      if (q_year_evaluated_30day[i]< Flow_p10_30day[i]){\n        Imp_year_evaluated_low_30d[i] <- (Flow_p10_30day[i]- q_year_evaluated_30day[i])/(Flow_p10_30day[i])\n      } else{\n        Imp_year_evaluated_low_30d[i] <- 0\n      }\n    }\n  }\n  Imp_year_evaluated_low <- cbind(Imp_year_evaluated_low_1d,Imp_year_evaluated_low_3d,\n                                  Imp_year_evaluated_low_7d,Imp_year_evaluated_low_30d)\n  ## 1 day high flow\n  Imp_year_evaluated_high_1d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_high_1d)){\n    if(is.na(q_year_evaluated[i])){\n      Imp_year_evaluated_high_1d[i] <- NA\n    } else {\n      if (q_year_evaluated[i]> Flow_p90_30day[i]){\n        Imp_year_evaluated_high_1d[i] <- (-Flow_p90_30day[i]+ q_year_evaluated[i])/(q_year_evaluated[i])\n      } else{\n        Imp_year_evaluated_high_1d[i] <- 0\n      }\n    }\n  }\n  ## 3 days high flow\n  Imp_year_evaluated_high_3d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_high_3d)){\n    if(is.na(q_year_evaluated_3day[i])){\n      Imp_year_evaluated_high_3d[i] <- NA\n    } else {\n      if (q_year_evaluated_3day[i]> Flow_p90_30day[i]){\n        Imp_year_evaluated_high_3d[i] <- (-Flow_p90_30day[i]+ q_year_evaluated_3day[i])/(q_year_evaluated_3day[i])\n      } else{\n        Imp_year_evaluated_high_3d[i] <- 0\n      }\n    }\n  }\n  ## 7 days high flow\n  Imp_year_evaluated_high_7d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_high_7d)){\n    if(is.na(q_year_evaluated_7day[i])){\n      Imp_year_evaluated_high_7d[i] <- NA\n    } else {\n      if (q_year_evaluated_7day[i]> Flow_p90_30day[i]){\n        Imp_year_evaluated_high_7d[i] <- (-Flow_p90_30day[i]+ q_year_evaluated_7day[i])/(q_year_evaluated_7day[i])\n      } else{\n        Imp_year_evaluated_high_7d[i] <- 0\n      }\n    }\n  }\n  ## 30 days high flow\n  Imp_year_evaluated_high_30d <- rep(0, layouts)\n  for(i in 1:length(Imp_year_evaluated_high_30d)){\n    if(is.na(q_year_evaluated_30day[i])){\n      Imp_year_evaluated_high_30d[i] <- NA\n    } else {\n      if (q_year_evaluated_30day[i]> Flow_p90_30day[i]){\n        Imp_year_evaluated_high_30d[i] <- (-Flow_p90_30day[i]+ q_year_evaluated_30day[i])/(q_year_evaluated_30day[i])\n      } else{\n        Imp_year_evaluated_high_30d[i] <- 0\n      }\n    }\n  }\n  Imp_year_evaluated_high <- cbind(Imp_year_evaluated_high_1d,Imp_year_evaluated_high_3d,\n                                   Imp_year_evaluated_high_7d,Imp_year_evaluated_high_30d)\n  require(plotrix)\n  eje_x <- 1:366\n  par(mar=c(4,4,4,4))\n  plot(eje_x,q_year_evaluated, col=1, type=\"l\",xaxt='n', ylab=\"\", xlab=\"\", ylim=c(0,max(q_year_evaluated,q_ref_high ,na.rm=T)*1.5),\n       xlim=c(0,366))#, yaxt=\"n\")\n  mtext(side=2,line=2.5,expression('Flow (m '^3*'/s)'))\n  x <- c(1:366,366:1)\n  poly_Flow_p90_p10_30day <- c(Flow_p90_30day,rev(Flow_p10_30day))\n  polygon(x, poly_Flow_p90_p10_30day, col = \"gray\", border = \"gray\")\n  lines(q_year_evaluated, col=1)\n  par(new=TRUE)\n  plot(eje_x, rowMeans(Imp_year_evaluated_low) ,,type=\"l\", bty=\"n\",xlab=\"\",ylab=\"\",col=2,\n       ylim=c(-7,2),xlim=c(0,366),axes = FALSE, yaxt=\"n\", main=paste(River_name,\"River - Impact in\", Year_evaluated))\n  lines(rowMeans(Imp_year_evaluated_high), col=4, lty=2)\n  mtext(side=4,line=2.3,expression('                                                     Impact on river flow'))\n  axis(1, lwd=1, at=0+15, labels=\"Oct\")\n  axis(1, lwd=1, at=31+15, labels=\"Nov\")\n  axis(1, lwd=1, at=61+15, labels=\"Dic\")\n  axis(1, lwd=1, at=92+15, labels=\"Jan\")\n  axis(1, lwd=1, at=123+15, labels=\"Feb\")\n  axis(1, lwd=1, at=152+15, labels=\"Mar\")\n  axis(1, lwd=1, at=183+15, labels=\"Apr\")\n  axis(1, lwd=1, at=213+15, labels=\"May\")\n  axis(1, lwd=1, at=244+15, labels=\"Jun\")\n  axis(1, lwd=1, at=274+15, labels=\"Jul\")\n  axis(1, lwd=1, at=305+15, labels=\"Aug\")\n  axis(1, lwd=1, at=336+15, labels=\"Sep\")\n  axis(4, lwd=1, at=0, labels=\"0\")\n  axis(4, lwd=1, at=1, labels=\"1\")\n}\n\n\n#' f_daily_costs6 - Calculates the daily environmental costs of flow regulation\n#' @param  First_day First day of the year to consider in the analysis starting on October 1st written as character (e.g. \"1964-10-01\")\n#' @param  Last_day First day of the year to consider in the analysis finishing on September 30th written as character (e.g. \"2011-09-30\")\n#' @param  Year_evaluated Year when the environmental impact is evaluated\n#' @param  Year_impact Year when the human impact started (e.g. the construction of a dam)\n#' @param  a_low Coefficient a of Low-flow impact of function ku (e.g. 0.05)\n#' @param  a_high Coefficient a of High-flow impact of function ku (e.g. 0.01)\n#' @param  b_low Coefficient b of Low-flow impact of function ku (e.g. 2)\n#' @param  b_high Coefficient b of High-flow impact of function ku (e.g. 2)\n#' @return Calculates the daily environmental costs of flow regulation for a specific year evaluated.\n#' @export\nf_daily_costs6 <- function(First_day, Last_day,Year_evaluated, Year_impact,a_low, a_high,b_low, b_high){\n  Impacts <- f_impact5(First_day=First_day, Last_day=Last_day,Year_evaluated=Year_evaluated, Year_impact=Year_impact)\n  Impact_Low <- Impacts$Impact_Low\n  Impact_High <- Impacts$Impact_High\n  Impact_Total <- Impacts$Impact_Total\n  ku_low <-  (c(rep(a_low,366))*(Impact_Low>0))*(exp(b_low*Impact_Low))\n  ku_high <-  (c(rep(a_high,366))*(Impact_High>0))*(exp(b_high*Impact_High))\n  ku <- ku_low+ku_high\n  Costs_Total <- Impact_Total*ku\n  Costs_Low <- Impact_Low*ku_low\n  Costs_High <- Impact_High*ku_high\n  Daily_Costs_results <- data.frame(Date=substr(seq(as.Date(\"2011-10-01\"), as.Date(\"2012-09-30\"), by=\"days\"), start = 6, stop = 11),\n                                    Impact_Low=Impact_Low, Impact_High=Impact_High, ku_low=ku_low, ku_high=ku_high,\n                                    Costs_Low=Costs_Low,Costs_High=Costs_High,Costs_Total=Costs_Total)\n  return(Daily_Costs_results)\n}\n\n\n\n#' f_daily_costs_plot6 - Plots the daily environmental costs of flow regulation\n#' @param  River_name Name of the river written as character (e.g. \"Ebro\")\n#' @param  First_day First day of the year to consider in the analysis starting on October 1st written as character (e.g. \"1964-10-01\")\n#' @param  Last_day First day of the year to consider in the analysis finishing on September 30th written as character (e.g. \"2011-09-30\")\n#' @param  Year_evaluated Year when the environmental impact is evaluated\n#' @param  Year_impact Year when the human impact started (e.g. the construction of a dam)\n#' @param  a_low Coefficient a of Low-flow impact of function ku (e.g. 0.05)\n#' @param  a_high Coefficient a of High-flow impact of function ku (e.g. 0.01)\n#' @param  b_low Coefficient b of Low-flow impact of function ku (e.g. 2)\n#' @param  b_high Coefficient b of High-flow impact of function ku (e.g. 2)\n#' @return Plots the daily environmental costs of flow regulation for a specific year evaluated.\n#' @export\nf_daily_costs_plot6 <- function(River_name, First_day, Last_day,Year_evaluated, Year_impact,a_low, a_high,b_low, b_high){\n  Impacts <- f_impact5(First_day=First_day, Last_day=Last_day,Year_evaluated=Year_evaluated, Year_impact=Year_impact)\n  Impact_Low <- Impacts$Impact_Low\n  Impact_High <- Impacts$Impact_High\n  Impact_Total <- Impacts$Impact_Total\n  ku_low <-  (c(rep(a_low,366))*(Impact_Low>0))*(exp(b_low*Impact_Low))\n  ku_high <-  (c(rep(a_high,366))*(Impact_High>0))*(exp(b_high*Impact_High))\n  ku <- ku_low+ku_high\n  Costs_Total <- Impact_Total*ku\n  Costs_Low <- Impact_Low*ku_low\n  Costs_High <- Impact_High*ku_high\n  plot(Costs_Total, type=\"l\", ylab=\"\", col=c(1),\n       xlab=\"\", xaxt='n', main=paste(River_name,\"River -\", Year_evaluated),\n       ylim=c(0,max(Impact_Total*ku, na.rm=T)*1.5))\n  lines(Costs_Low, col=2)\n  lines(Costs_High, col=4)\n  lines(c(rep(0,366)), col=1)\n  legend(\"topleft\", legend = c(paste(\"Low-flow env. costs\", \" (a = \", a_low,  \", b = \",b_low, \")\", sep=\"\"),\n                               paste(\"High-flow env. costs\", \" (a = \", a_high, \", b = \",b_high, \")\", sep=\"\")),\n         col=c(2,4), pch=1,cex=0.8)\n  mtext(expression('Environmental Costs ( Eur / m '^3*')') , side=2, line=2.5)\n  axis(1, lwd=1, at=0+15, labels=\"Oct\")\n  axis(1, lwd=1, at=31+15, labels=\"Nov\")\n  axis(1, lwd=1, at=61+15, labels=\"Dic\")\n  axis(1, lwd=1, at=92+15, labels=\"Jan\")\n  axis(1, lwd=1, at=123+15, labels=\"Feb\")\n  axis(1, lwd=1, at=152+15, labels=\"Mar\")\n  axis(1, lwd=1, at=183+15, labels=\"Apr\")\n  axis(1, lwd=1, at=213+15, labels=\"May\")\n  axis(1, lwd=1, at=244+15, labels=\"Jun\")\n  axis(1, lwd=1, at=274+15, labels=\"Jul\")\n  axis(1, lwd=1, at=305+15, labels=\"Aug\")\n  axis(1, lwd=1, at=336+15, labels=\"Sep\")\n}\n",
    "created" : 1504790576755.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "404195438",
    "id" : "2740BEEC",
    "lastKnownWriteTime" : 1504782689,
    "last_content_update" : 1504782689,
    "path" : "~/R/FlowRegEnvCost/R/FlowRegEnvCosts.R",
    "project_path" : "R/FlowRegEnvCosts.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}